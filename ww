const { Telegraf, Markup } = require('telegraf');
const config = require('./config');
const fs = require('fs');
const bot = new Telegraf(config.telegramToken);
var inputMode = {};
var userProjects = {};
var namesProjChoise = {}
var currentTime = {}
const projects = ["entry.114962959", "entry.1174823241", "entry.1315587285", "entry.1271011164", "entry.798682550", "entry.529707128", "entry.864116383", "entry.1277828144", "entry.648396435", "entry.1609659424", "entry.1958276645", "entry.1624308407", "entry.1731444995", "entry.1817660369", "entry.1286147655", "entry.1631343816", "entry.267764195", "entry.548035864", "entry.1290202242", "entry.1682447098", "entry.351380903", "entry.1867198783", "entry.839054733", "entry.2029053668", "entry.222491728", "entry.435825602", "entry.842585678", "entry.349424234", "entry.1532343057", "entry.1546192729", "entry.225131034", "entry.1558092545", "entry.923080069", "entry.800611585", "entry.570852682", "entry.1792627242", "entry.626348380", "entry.272220642", "entry.1550213116", "entry.1832892167", "entry.1491611559", "entry.460562156", "entry.983334088", "entry.49608760", "entry.673000119", "entry.535142438", "entry.604339736", "entry.1541318123", "entry.1768968497", "entry.48700471", "entry.1021887040", "entry.1403719617", "entry.172656762"];
const projectsNames = [
    "ÐÐ»ÐºÐ¾Ñ€Ð°Ð¼ÐºÐ°-ÐŸÑ€Ð¾",
    "ÐÐ»ÐºÐ¾Ð·Ð°Ð¼Ð¾Ðº-ÐŸ-01",
    "ÐÐ»ÐºÐ¾Ð·Ð°Ð¼Ð¾Ðº-ÐŸ-02",
    "ÐÐ»ÐºÐ¾Ð·Ð°Ð¼Ð¾Ðº-Ðœ",
    "ÐÐ»ÐºÐ¾Ð·Ð°Ð¼Ð¾Ðº-Ðœ-PRO",
    "ÐÐ»ÐºÐ¾Ð·Ð°Ð¼Ð¾Ðº-ÐŸ-PRO",
    "Ð’ÐžÐ›Ð—-0.9",
    "Ð’ÐžÐ›Ð—-Ð¡Ð˜",
    "Ð“Ð°Ð·Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ‚Ð¾Ñ€",
    "Ð˜Ð’Ð›/ÐŸÐ›Ð’",
    "Ð˜Ð·Ð³Ð¾Ñ‚Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ (Ð¡Ð˜Ð“ÐÐÐ›)",
    "Ðœ-350 ÐœÐÐ˜",
    "Ðœ-350 Ð£Ð£ÐÐ˜Ð¢",
    "Ðœ-350 Ð£ÐŸÐšÐ‘",
    "Ðœ-250 Ð£ÐŸÐšÐ‘",
    "Ðœ-350 ÐŸÐÐŸÐŸÐš",
    "Ðœ-350 Ð˜Ð¡Ð¡",
    "Ðœ-350 Ð¡Ð°Ð¼Ð°Ñ€Ð°",
    "Ðœ-350 ÐŸÐÐ˜ÐŸÐ£",
    "Ðœ-350 Ð¦ÐÐ¢",
    "Ðœ-350 Ð¦ÐÐ¢-ÐžÐ¡ÐÐžÐ’Ð",
    "Ðœ-350 ÐšÐ‘Ð¥Ð",
    "Ðœ-450-Ðœ Ð£Ð—Ð“Ð",
    "Ðœ-450-Ðœ Ð¢ÑƒÐ»Ð°",
    "Ðœ-450-Ðœ Ð¡Ð¸Ð»Ð¾Ð²Ñ‹Ðµ Ð¼Ð°ÑˆÐ¸Ð½Ñ‹",
    "ÐšÐ¡Ðž",
    "Ð›ÑƒÑ‡-1",
    "ÐžÐ±Ð»Ð°ÐºÐ¾Ð¼ÐµÑ€ (Skydex-15)",
    "Skydex-9",
    "ÐžÐ´Ð¸ÑÑÐµÐ¹",
    "ÐŸÐ›Ð’-300 Ð‘Ð°Ð¹ÐºÐ¾Ð½ÑƒÑ€",
    "ÐŸÑ€Ð¾Ð¼ÐµÑ‚ÐµÐ¹",
    "ÐŸÑ‹Ð»ÑŒ",
    "Ð ÐµÐ¼Ð¾Ð½Ñ‚-Ð Ð¥Ð‘Ð—",
    "Ð¡ÐºÐ°Ð½ÐµÑ€ Ð¡ÐŸÐ˜Ð",
    "Ð¡Ð›Ðš",
    "Ð£Ð¡Ð¡Ðž Ð¡ÐµÑ€Ð²Ð¸Ñ",
    "109-Ð¡ÐšÐÐÐ•Ð -Ð”Ð˜Ð Ð•ÐšÐ¢ Ð¤1",
    "109-Ð¡ÐšÐÐÐ•Ð -Ð”Ð˜Ð Ð•ÐšÐ¢ Ð¤2",
    "109-Ð¡ÐšÐÐÐ•Ð -Ð¢Ð•Ð Ð Ð",
    "2136-Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ÐÐœÐš-Ðœ-450",
    "2136-Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ðœ-150",
    "2136-Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ðœ-450",
    "Ð¡Ð›Ðœ ÐŸÐž-2.0",
    "Ð’Ñ‹Ñ€Ð°Ñ‰Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹",
    "Ð”ÐµÑ€Ð¶Ð¸Ð½ÐµÑ†-1 Ð Ð¢Ð˜",
    "Ð Ð°Ð·Ð³Ð¾Ð½-ÐŸÐŸÐ¡",
    "Ð Ð°Ð·Ð³Ð¾Ð½-Ð¡Ð”Ð˜",
    "Ð Ð°Ð·Ð³Ð¾Ð½-Ð¡Ð",
    "Ð Ð°Ð·Ð³Ð¾Ð½-Ð¡Ðž",
    "Ð Ð°Ð´Ð¸Ð¾Ñ„Ð¾Ñ‚Ð¾Ð½Ð¸ÐºÐ°",
    "Ð¢ÐµÑ€Ð¼Ð¾ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ",
    "ÐŸÑ€Ð¾Ñ‡ÐµÐµ"
];

bot.start(async (ctx) => {
    const users = await allUsers();
    console.log(users);
    const userId = ctx.from.id;
    console.log(userId);
    if (userId in inputMode) return ctx.reply(`Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñƒ.\nÐ˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡`);
    if (users.hasOwnProperty(userId)) {
        ctx.reply(`Ð’Ñ‹ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð² Ð½Ð°ÑˆÐµÐ¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ Ð¿Ð¾Ð´ Ð¸Ð¼ÐµÐ½ÐµÐ¼ ${users[userId].name}\nÐ–ÐµÐ»Ð°ÐµÑ‚Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ?`, 
            Markup.inlineKeyboard([
                Markup.button.callback('ðŸ‘¤ Ð”Ð°, Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ', 'yeschange'),
                Markup.button.callback('ðŸ“ ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒÑÑ', 'settime')
            ])
        );
        return;
    } else {
        ctx.reply(`Ð’Ñ‹ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚Ðµ Ð² Ð½Ð°ÑˆÐµÐ¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ\nÐ–ÐµÐ»Ð°ÐµÑ‚Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ?`, 
            Markup.inlineKeyboard([
                Markup.button.callback('Ð”Ð°', 'yesregister'),
                Markup.button.callback('ÐÐµÑ‚', 'noregister')
            ])
        );
        return;
    }
});

bot.on("message", (ctx) => {
    const userId = ctx.from.id;
    if (userId in inputMode) {
        // Ð—Ð´ÐµÑÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð²Ð²Ð¾Ð´Ð°
    } else {
        return ctx.reply(`Ð¡ÐµÐ¹Ñ‡Ð°Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽÑ‚ÑÑ.`);
    }
    const messageText = ctx.message.text;
    const words = messageText.trim().split(/\s+/);
    if (words.length === 3) {
        const name = ctx.message.text.toUpperCase();
        writeDataName(userId, name);
        delete inputMode[userId];
        ctx.deleteMessage();
        
        ctx.reply(`Ð—Ð°Ð¿Ð¾Ð¼Ð½Ð¸Ð» Ð²Ð°Ñ ÐºÐ°Ðº\n${name}`, 
            Markup.inlineKeyboard([
                Markup.button.callback('ðŸ“ ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒÑÑ', 'settime')
            ])
        );
    } else if (isValidDate(messageText)) {
        delete inputMode[userId];
        const [day, month, year] = messageText.split('.').map(part => parseInt(part, 10));
        console.log(day,month,year)
        currentTime[userId] = { Y: year, M: month, D: day};
        const buttons = projectsNames.map((project, index) => [Markup.button.callback(`${index} - ${project}`, `project_${index}`)]);
        ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹', Markup.inlineKeyboard(buttons));
    } else {
        ctx.reply(`ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¸Ð»Ð¸ Ð´Ð°Ñ‚Ñ‹`);
    }
});


bot.action('yesregister', (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    inputMode[ctx.from.id] = true;
    console.log(inputMode);
    ctx.reply('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñƒ.\Ð½Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡');
});

bot.action('yeschange', (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    inputMode[ctx.from.id] = true;
    console.log(inputMode);
    ctx.reply('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¸Ð¼Ñ Ñ„Ð°Ð¼Ð¸Ð»Ð¸ÑŽ ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñƒ.\Ð½Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡');
});

bot.action('settime', async (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    const users = await allUsers();
    const userId = ctx.from.id;

    const keyboard = [
        [
            Markup.button.callback('Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ', 'today'),
            Markup.button.callback('Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ', 'writetime')
        ]
    ];
    let tex = ''
    if (users[userId].last) {
        tex = `\n\nÐŸÑ€Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€Ðµ "ÐšÐ°Ðº Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ñ‹Ð¹ Ñ€Ð°Ð·" - ÐŸÑ€Ð¾ÐµÐºÑ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ñ‹ Ñ‚Ð°Ðº Ð¶Ðµ ÐºÐ°Ðº Ð²Ñ‹ ÑÑ‚Ð¾ ÑÐ´ÐµÐ»Ð°Ð»Ð¸ Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ñ‹Ð¹ Ñ€Ð°Ð·.`
        keyboard.push([
            Markup.button.callback('ÐšÐ°Ðº Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ñ‹Ð¹ Ñ€Ð°Ð·', 'revind')
        ]);
    }

    ctx.reply(`Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð°Ñ‚Ñƒ, Ð·Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ. ${tex}`, Markup.inlineKeyboard(keyboard));
});


bot.action('today', async (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    const users = await allUsers();
    const userId = ctx.from.id;
    const currentDate = new Date();

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1; // ÐœÐµÑÑÑ†Ñ‹ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÑŽÑ‚ÑÑ Ñ 0, Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ 1
    const day = currentDate.getDate();
    currentTime[userId] = { Y: year, M: month, D: day}
    const buttons = projectsNames.map((project, index) => [Markup.button.callback(`${index} - ${project}`, `project_${index}`)]);
    ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹', Markup.inlineKeyboard(buttons));
});
bot.action('writetime', (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    inputMode[ctx.from.id] = true;
    ctx.reply('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ñ‚Ñƒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ "Ð”Ð”.ÐœÐœ.Ð“Ð“Ð“Ð“", Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ "01.01.2024".');
});
bot.action('revind', (ctx) => {
    ctx.reply('ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ñ„Ð¾Ñ€Ð¼Ñ‹.\nÐ¤Ð¾Ñ€Ð¼Ð° Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼.\nÐ”Ð°Ñ‚Ð°:');
})


projectsNames.forEach((project, index) => {
    bot.action(`project_${index}`, (ctx) => {
        ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        const userId = ctx.from.id;
        if (!userProjects[userId]) {
            userProjects[userId] = [];
        }
        userProjects[userId].push(projects[index]);
        if (namesProjChoise[userId]) {
            namesProjChoise[userId].push(project)
        } else {
            // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
            namesProjChoise[userId] = [];
            namesProjChoise[userId].push(project)
        }
        const selectedProjects = namesProjChoise[userId].map(proj => `â˜‘ï¸ ${proj}`).join('\n'); 

        ctx.reply(`Ð’Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚: ${project}\nÐ’ÑÐµÐ³Ð¾ Ð²Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸:\n${selectedProjects}\n\nÐ’ÑÐµÐ³Ð¾ Ð²Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ ${userProjects[userId]}`, 
            Markup.inlineKeyboard([
                Markup.button.callback('Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐµÑ‰Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚', 'add_more_projects'),
                Markup.button.callback('Ð“Ð¾Ñ‚Ð¾Ð²Ð¾', 'done')
            ])
        );
    });
});

bot.action('add_more_projects', (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    const buttons = projectsNames.map((project, index) => [Markup.button.callback(`${index} - ${project}`, `project_${index}`)]);
    ctx.reply('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñ‹', Markup.inlineKeyboard(buttons));
});

bot.action('done', (ctx) => {
    ctx.deleteMessage(); // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    const userId = ctx.from.id;
    if (!userProjects[userId] || userProjects[userId].length === 0) {
        return ctx.reply('Ð’Ñ‹ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð½Ð¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°.');
    }
    // Ð—Ð´ÐµÑÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…

    sendForm(userId);
    ctx.reply('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹.');
});

bot.launch();

function allUsers() {
    return new Promise((resolve, reject) => {
        fs.readFile('users.json', 'utf8', (err, data) => {
            if (err) {
                reject(err);
                return;
            }
            try {
                const users = JSON.parse(data);
                resolve(users);
            } catch (error) {
                reject(error);
            }
        });
    });
}

async function writeDataName(user, data) {
    const userDataAll = await allUsers();

    if (userDataAll[user]) {
        userDataAll[user].name = data;
    } else {
        // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        userDataAll[user] = { name: data };
    }
    const jsonData = JSON.stringify(userDataAll, null, 2);
    fs.writeFile('./users.json', jsonData, 'utf8', (err) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ„Ð°Ð¹Ð»Ð°:', err);
        } else {
            console.log('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð² Ñ„Ð°Ð¹Ð».');
        }
    });
}
async function writeDataLast(user, data) {
    const userDataAll = await allUsers();

    if (userDataAll[user]) {
        userDataAll[user].last = data;
    } else {
        // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…
        userDataAll[user] = { name: data };
    }
    const jsonData = JSON.stringify(userDataAll, null, 2);
    fs.writeFile('./users.json', jsonData, 'utf8', (err) => {
        if (err) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸ Ñ„Ð°Ð¹Ð»Ð°:', err);
        } else {
            console.log('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Ð² Ñ„Ð°Ð¹Ð».');
        }
    });
}

async function sendForm(userId) {
    const userName = await allUsers()
    const GoogleURL = 'https://docs.google.com/forms/d/e/1FAIpQLSdikzcL-InKRw_lbmpTysxtwQx0Wb7l8F2fROJkJiaNyCNp7A/formResponse';
    const urlReferer = 'https://docs.google.com/forms/d/e/1FAIpQLSdikzcL-InKRw_lbmpTysxtwQx0Wb7l8F2fROJkJiaNyCNp7A/viewform';
    let formData = new FormData();
    console.log(`Ð“Ð¾Ð´ ` + currentTime[userId].Y)
    console.log(`ÐœÐµÑÑÑ† ` + currentTime[userId].M)
    console.log(`Ð”ÐµÐ½ÑŒ ` + currentTime[userId].D)
    console.log(`entry.1970048429 ` + userName[userId].name)
    distributeHours(projects, userProjects[userId]);
    console.log(`entry.172335038 ` + ``)
    writeDataLast(userId, userProjects[userId])
}








/*function sendForm(year, month, day, userName) {
    const GoogleURL = 'https://docs.google.com/forms/d/e/1FAIpQLSdikzcL-InKRw_lbmpTysxtwQx0Wb7l8F2fROJkJiaNyCNp7A/formResponse';
    const urlReferer = 'https://docs.google.com/forms/d/e/1FAIpQLSdikzcL-InKRw_lbmpTysxtwQx0Wb7l8F2fROJkJiaNyCNp7A/viewform';
    let formData = new FormData();
    formData.append('entry.210931804_year', `${year}`);
    formData.append('entry.210931804_month', `${month}`);
    formData.append('entry.210931804_day', `${day}`);
    formData.append('entry.1970048429', `${userName}`); // Ð˜Ð¼Ñ
    formData.append('entry.1036971134', `ÐÐµÑ‚`);
    formData.append('entry.744013520', ``); // Ð“Ð¾Ñ€Ð¾Ð´ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¸Ñ€Ð¾Ð²ÐºÐ¸
    formData.append('entry.460071324', ``); // ÐžÑ‚Ð¿ÑƒÑÐº Ð±Ð¾Ð»ÑŒÐ½Ð¸Ñ‡Ð½Ñ‹Ð¹
    distributeHours(projects, userProjects[userId]);
    formData.append('entry.172335038', ``); // ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹

    fetch(GoogleURL, {
        method: 'POST',
        headers: {
            'Referer': urlReferer
        },
        body: formData
    }).then(response => {
        console.log('Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹:', response);
    }).catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ…:', error);
    });
}
*/
const distributeHours = (projects, pon, totalHours = 8) => {
    let projectsCount = pon.length;
    let hoursPerProject = [];
    let remainingHours = totalHours;

    for (let i = 0; i < projectsCount; i++) {
        let hours = Math.floor(remainingHours / (projectsCount - i) * 2) / 2; // Ð¾ÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ Ð´Ð¾ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐµÐ³Ð¾ 0.5
        hoursPerProject.push(hours);
        remainingHours -= hours;
    }

    let hoursMap = {};
    pon.forEach((projectId, index) => {
        hoursMap[projectId] = hoursPerProject[index];
    });

    projects.forEach((projectId) => {
        if (hoursMap[projectId] !== undefined) {
            //formData.append(`entry.${projectId}`, `${hoursMap[projectId]}`);
            console.log(`entry.${projectId}, ${hoursMap[projectId]}`);
        } else {
            //formData.append(`entry.${projectId}`, ``);
            console.log(`entry.${projectId}`);
        }
    });
};
const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/
function isValidDate(text) {
    return dateRegex.test(text);
}